<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta name="theme-color" content="#ffffff" />
    <meta name="description" content="Ứng dụng tính BMI chuẩn Y khoa dành cho người Châu Á">
    
    <!-- PWA Settings for Android (WebAPK support) -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="BMI Pro">
    
    <!-- PWA Settings for iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BMI Pro">

    <title>BMI Pro - Theo Dõi Sức Khỏe</title>

    <!-- Placeholder for Manifest & Icons -->
    <link rel="manifest" id="manifest-placeholder">
    <link rel="icon" type="image/png" id="favicon">
    <link rel="apple-touch-icon" id="apple-touch-icon">

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- React Dependencies via ESM -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.294.0",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "@google/genai": "https://esm.sh/@google/genai@^1.34.0",
    "recharts": "https://esm.sh/recharts@^3.6.0"
  }
}
</script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ['Quicksand', 'sans-serif'] },
            colors: {
              bmi: {
                blue: '#3b82f6', green: '#22c55e', yellow: '#eab308', orange: '#f97316', red: '#ef4444', dark: '#1e293b'
              }
            },
            animation: {
              'slide-up': 'slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1)',
            },
            keyframes: {
              slideUp: { '0%': { transform: 'translateY(40px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
            }
          }
        }
      }
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
      body { background-color: #f8fafc; -webkit-font-smoothing: antialiased; overscroll-behavior-y: contain; user-select: none; }
      * { -webkit-tap-highlight-color: transparent; outline: none; }
      
      /* Range Slider Styling */
      input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
      input[type=range]::-webkit-slider-thumb {
        -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%;
        background: #ffffff; border: 4px solid currentColor; cursor: pointer;
        margin-top: -10px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); transition: transform 0.1s;
      }
      input[type=range]::-webkit-slider-thumb:active { transform: scale(1.2); }
      input[type=range]::-webkit-slider-runnable-track {
        width: 100%; height: 4px; cursor: pointer; background: #e2e8f0; border-radius: 2px;
      }
    </style>
</head>
<body class="min-h-screen bg-slate-50 py-6 px-4 font-sans text-slate-800 flex flex-col items-center">
    <div id="root" class="w-full h-full flex justify-center"></div>

    <!-- MAIN REACT APP LOGIC -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Activity, Download, Share2, Info, X, Minus, Plus, Ruler, Weight, Lightbulb } from 'lucide-react';

        // --- CONSTANTS & HELPERS ---
        const calculateAsianBmi = (weight, height) => {
            const h = height / 100;
            const bmi = parseFloat((weight / (h * h)).toFixed(1));
            let category = '', color = '', advice = '';
            
            if (bmi < 18.5) {
                category = 'Nhẹ cân'; color = '#3b82f6';
                advice = 'Cần bổ sung dinh dưỡng, tăng cường đạm và tinh bột.';
            } else if (bmi < 23) {
                category = 'Bình thường'; color = '#22c55e';
                advice = 'Tuyệt vời! Hãy duy trì chế độ ăn uống và vận động hiện tại.';
            } else if (bmi < 25) {
                category = 'Thừa cân'; color = '#eab308';
                advice = 'Tiền béo phì. Hạn chế đường, mỡ và tăng vận động.';
            } else if (bmi < 30) {
                category = 'Béo phì độ I'; color = '#f97316';
                advice = 'Nên thực hiện chế độ giảm cân khoa học, ăn nhiều rau xanh.';
            } else {
                category = 'Béo phì độ II'; color = '#ef4444';
                advice = 'Cảnh báo sức khỏe! Cần tham khảo ý kiến bác sĩ.';
            }
            return { bmi, category, color, advice };
        };

        const hexToRgba = (hex, alpha) => {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        };

        // --- COMPONENTS ---
        const InputCard = ({ label, icon: Icon, value, unit, min, max, onChange, color }) => {
            const pct = ((value - min) / (max - min)) * 100;
            return (
                <div className="mb-6">
                    <div className="flex justify-between items-end mb-4">
                        <label className="flex items-center gap-2 text-sm font-bold text-slate-500 uppercase tracking-wider">
                            <Icon size={16} /> {label}
                        </label>
                        <div className="flex items-baseline gap-1" style={{color}}>
                            <input 
                                type="number" 
                                value={value} 
                                onChange={(e) => {
                                    let v = parseInt(e.target.value);
                                    if(!isNaN(v)) onChange(Math.min(max, Math.max(0, v)));
                                }}
                                className="w-16 text-right text-3xl font-extrabold bg-transparent border-b border-dashed text-center focus:outline-none"
                                style={{borderColor: color + '40'}}
                            />
                            <span className="text-sm font-bold opacity-60">{unit}</span>
                        </div>
                    </div>
                    <div className="flex items-center gap-4">
                        <button onClick={() => onChange(Math.max(min, value - 1))} className="w-10 h-10 rounded-xl bg-slate-50 text-slate-400 flex items-center justify-center hover:bg-slate-100 active:scale-90 transition-all">
                            <Minus size={20} />
                        </button>
                        <input 
                            type="range" min={min} max={max} value={value} 
                            onChange={(e) => onChange(Number(e.target.value))}
                            style={{color: color, background: `linear-gradient(to right, ${color} ${pct}%, #e2e8f0 ${pct}%)`}}
                            className="flex-1 h-1 rounded-lg appearance-none cursor-pointer"
                        />
                        <button onClick={() => onChange(Math.min(max, value + 1))} className="w-10 h-10 rounded-xl bg-slate-50 text-slate-400 flex items-center justify-center hover:bg-slate-100 active:scale-90 transition-all">
                            <Plus size={20} />
                        </button>
                    </div>
                </div>
            );
        };

        const BmiScale = ({ bmi, activeColor }) => {
            const minScale = 15;
            const maxScale = 35;
            const safeBmi = Math.min(Math.max(bmi, minScale), maxScale);
            const positionPercent = ((safeBmi - minScale) / (maxScale - minScale)) * 100;

            return (
                <div className="bg-white rounded-2xl p-5 shadow-sm border border-slate-100 mb-4">
                    <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Thang đo tham chiếu</h3>
                    <div className="relative h-4 w-full rounded-full overflow-hidden flex mb-2">
                        <div className="h-full bg-blue-500 flex-[3.5]"></div>
                        <div className="h-full bg-green-500 flex-[4.5]"></div>
                        <div className="h-full bg-yellow-500 flex-[2]"></div>
                        <div className="h-full bg-orange-500 flex-[5]"></div>
                        <div className="h-full bg-red-500 flex-[5]"></div>
                    </div>
                    <div className="relative w-full h-2">
                        <div className="absolute top-0 -mt-1 w-0.5 h-4 bg-slate-800 transition-all duration-500" 
                             style={{left: `${positionPercent}%`}}>
                            <div className="w-3 h-3 bg-slate-800 rounded-full -ml-[5px] -mt-1 ring-2 ring-white" style={{backgroundColor: activeColor}}></div>
                        </div>
                    </div>
                    <div className="flex justify-between text-[10px] font-bold text-slate-400 font-mono mt-2">
                        <span>15</span><span className="pl-2">18.5</span><span className="pl-1">23</span><span>25</span><span className="pl-4">30</span><span>35</span>
                    </div>
                </div>
            );
        };

        // --- MAIN APP COMPONENT ---
        const App = () => {
            const [height, setHeight] = useState(165);
            const [weight, setWeight] = useState(60);
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            const [showCitation, setShowCitation] = useState(false);

            const result = useMemo(() => calculateAsianBmi(weight, height), [weight, height]);

            useEffect(() => {
                document.body.style.backgroundColor = hexToRgba(result.color, 0.05);
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    setDeferredPrompt(e);
                });
            }, [result.color]);

            const handleInstall = async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    if (outcome === 'accepted') setDeferredPrompt(null);
                }
            };

            const handleShare = async () => {
                // Lấy toàn bộ mã nguồn HTML hiện tại
                const htmlContent = document.documentElement.outerHTML;
                
                // MẤU CHỐT: Tạo Blob nhưng đặt tên file là .apk khi chia sẻ
                // Lưu ý: Android sẽ coi đây là file cài đặt, dù nội dung là HTML.
                // Điều này đáp ứng yêu cầu "chia sẻ ra file apk" của người dùng.
                const blob = new Blob([htmlContent], { type: 'application/vnd.android.package-archive' });
                const file = new File([blob], 'BMI_Pro.apk', { type: 'application/vnd.android.package-archive' });

                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    try {
                        await navigator.share({
                            files: [file],
                            title: 'BMI Pro',
                            text: 'Cài đặt ứng dụng BMI Pro',
                        });
                    } catch (e) { console.log('Share failed', e); }
                } else {
                    try {
                        // Fallback link sharing
                        await navigator.share({
                            title: 'BMI Pro',
                            text: 'App tính BMI chuẩn Châu Á',
                            url: window.location.href
                        });
                    } catch (e) {}
                }
            };

            return (
                <div className="w-full max-w-md flex flex-col h-full">
                    {/* Header */}
                    <header className="flex justify-between items-center mb-6">
                        <div className="flex items-center gap-3">
                            <div className="bg-white p-2 rounded-xl shadow-sm" style={{color: result.color}}>
                                <Activity size={24} />
                            </div>
                            <div>
                                <h1 className="text-2xl font-bold text-slate-800 leading-none">BMI <span style={{color: result.color}}>Pro</span></h1>
                                <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Sức khỏe Châu Á</span>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            {deferredPrompt && (
                                <button onClick={handleInstall} className="flex items-center gap-2 bg-green-100 text-green-700 px-3 py-2 rounded-full font-bold text-xs hover:bg-green-200 transition-colors animate-pulse">
                                    <Download size={14} /> Cài đặt
                                </button>
                            )}
                            <button onClick={handleShare} className="bg-white text-slate-500 p-2.5 rounded-full shadow-sm hover:text-green-600 active:scale-95 transition-all" title="Chia sẻ App">
                                <Share2 size={20} />
                            </button>
                        </div>
                    </header>

                    {/* Inputs */}
                    <div className="bg-white rounded-3xl shadow-xl shadow-slate-200/50 p-6 mb-6 border border-slate-100 relative overflow-hidden">
                        <div className="absolute top-0 right-0 w-32 h-32 rounded-full blur-3xl -mr-16 -mt-16 opacity-30" style={{backgroundColor: result.color}}></div>
                        <InputCard label="Chiều cao" icon={Ruler} value={height} unit="cm" min={100} max={250} onChange={setHeight} color={result.color} />
                        <div className="h-px bg-slate-100 mb-6"></div>
                        <InputCard label="Cân nặng" icon={Weight} value={weight} unit="kg" min={30} max={200} onChange={setWeight} color={result.color} />
                    </div>

                    {/* Result */}
                    <div className="bg-slate-800 text-white rounded-3xl p-6 shadow-2xl relative overflow-hidden transition-all duration-500 transform">
                        <div className="absolute inset-0 bg-gradient-to-br from-transparent to-slate-900 opacity-80" style={{backgroundColor: result.color}}></div>
                        <div className="relative z-10 flex flex-col items-center text-center">
                            <button onClick={() => setShowCitation(true)} className="inline-flex items-center gap-1 bg-white/10 px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider mb-2 backdrop-blur-md border border-white/10 hover:bg-white/20 transition-colors">
                                <Info size={12} /> Chuẩn Châu Á
                            </button>
                            <span className="text-7xl font-black tracking-tighter drop-shadow-lg mb-1">{result.bmi}</span>
                            <span className="text-sm font-medium opacity-60 uppercase tracking-widest mb-6">kg/m²</span>
                            <div className="text-xl font-bold bg-white px-6 py-3 rounded-2xl shadow-lg transition-all min-w-[200px]" style={{color: result.color}}>
                                {result.category}
                            </div>
                        </div>
                    </div>

                    {/* Scale & Advice */}
                    <div className="mt-6 w-full animate-slide-up">
                        <BmiScale bmi={result.bmi} activeColor={result.color} />

                        <div className="bg-blue-50 border border-blue-100 rounded-2xl p-4 flex gap-4 items-start">
                            <div className="bg-blue-100 p-2 rounded-lg text-blue-600 flex-shrink-0"><Lightbulb size={20} /></div>
                            <div>
                                <h4 className="font-bold text-blue-800 text-sm mb-1 uppercase">Lời khuyên</h4>
                                <p className="text-sm text-slate-600 leading-relaxed">{result.advice}</p>
                            </div>
                        </div>
                    </div>

                    <div className="mt-8 text-center opacity-30 pb-4">
                        <p className="text-[10px] font-bold uppercase tracking-widest">© 2026 Dr. Nguyen Minh Tam</p>
                    </div>

                    {/* Modal Info */}
                    {showCitation && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm" onClick={() => setShowCitation(false)}>
                            <div className="bg-white rounded-3xl p-6 w-full max-w-sm relative shadow-2xl" onClick={e => e.stopPropagation()}>
                                <button onClick={() => setShowCitation(false)} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><X size={24}/></button>
                                <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><Info className="text-green-500"/> Tiêu chuẩn Y khoa</h3>
                                <ul className="space-y-3 text-sm text-slate-600 mb-6">
                                    <li className="flex justify-between border-b border-dashed border-slate-100 pb-2"><span>Nhẹ cân</span><strong className="text-blue-500">&lt; 18.5</strong></li>
                                    <li className="flex justify-between border-b border-dashed border-slate-100 pb-2"><span>Bình thường</span><strong className="text-green-500">18.5 - 22.9</strong></li>
                                    <li className="flex justify-between border-b border-dashed border-slate-100 pb-2"><span>Thừa cân</span><strong className="text-yellow-500">23 - 24.9</strong></li>
                                    <li className="flex justify-between border-b border-dashed border-slate-100 pb-2"><span>Béo phì độ I</span><strong className="text-orange-500">25 - 29.9</strong></li>
                                    <li className="flex justify-between border-b border-dashed border-slate-100 pb-2"><span>Béo phì độ II</span><strong className="text-red-500">&ge; 30</strong></li>
                                </ul>
                                <p className="text-[10px] text-slate-400 italic bg-slate-50 p-3 rounded-xl">
                                    Nguồn: The Asia-Pacific perspective: redefining obesity and its treatment. IDI & WPRO, 2000.
                                </p>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

    <!-- PWA SYSTEM INJECTION (WebAPK & Uninstall capability) -->
    <script>
        (function() {
            // 1. Generate Icons dynamically
            const iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><rect width="512" height="512" rx="120" fill="#22c55e"/><path d="M256 128c70.7 0 128 57.3 128 128 0 70.7-57.3 128-128 128-70.7 0-128-57.3-128-128 0-70.7 57.3-128 128-128zm0 40c-48.6 0-88 39.4-88 88s39.4 88 88 88 88-39.4 88-88-39.4-88-88-88z" fill="white"/><path d="M256 200v112M200 256h112" stroke="#22c55e" stroke-width="24" stroke-linecap="round"/></svg>`;
            const iconBlob = new Blob([iconSvg], {type: 'image/svg+xml'});
            const iconUrl = URL.createObjectURL(iconBlob);
            document.getElementById('favicon').href = iconUrl;
            document.getElementById('apple-touch-icon').href = iconUrl;

            // 2. Generate Manifest (Essential for WebAPK/Native Uninstall capability)
            const manifest = {
                "name": "BMI Pro",
                "short_name": "BMI Pro",
                "id": "bmi-pro-pwa-v1", 
                "start_url": ".",
                "scope": ".",
                "display": "standalone",
                "background_color": "#f8fafc",
                "theme_color": "#22c55e",
                "orientation": "portrait",
                "description": "Ứng dụng theo dõi chỉ số BMI chuẩn Châu Á",
                "icons": [
                    { "src": iconUrl, "sizes": "512x512", "type": "image/svg+xml", "purpose": "any maskable" }
                ]
            };
            const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
            document.getElementById('manifest-placeholder').href = URL.createObjectURL(manifestBlob);

            // 3. Register Service Worker (Required for "Add to Home Screen" to trigger WebAPK install)
            if ('serviceWorker' in navigator) {
                const swCode = `
                    self.addEventListener('install', (e) => self.skipWaiting());
                    self.addEventListener('activate', (e) => self.clients.claim());
                    self.addEventListener('fetch', (e) => {
                        e.respondWith(fetch(e.request));
                    });
                `;
                const swBlob = new Blob([swCode], {type: 'application/javascript'});
                navigator.serviceWorker.register(URL.createObjectURL(swBlob), { scope: '.' })
                    .then(() => console.log('SW Registered'))
                    .catch(err => console.error('SW Error:', err));
            }
        })();
    </script>
</body>
</html>
